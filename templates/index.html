<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RespiScan AI ‚Äî Chest X-ray Screening</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+Devanagari:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body
  class="{% if (summary_np or (request.form.get('lang')=='np')) %}lang-np{% endif %}"
  data-home="{{ url_for('index') }}"
>

  <!-- App Bar (title centered) -->
  <header class="appbar appbar-center">
    <button id="btnMenu" class="icon-btn" aria-label="Open settings">‚ò∞</button>
    <div class="brand center">
      <div class="logo" aria-hidden="true">ü´Å</div>
      <div>
        <h1>RespiScan AI</h1>
        <p>Fast, simple chest X-ray screening ‚Äî üá≥üáµ Nepali & English</p>
      </div>
    </div>
    <div class="right-actions">
      <button id="btnReport" class="btn secondary" type="button">üí¨ Feedback</button>
    </div>
  </header>

  <!-- Settings Drawer -->
  <aside id="drawer" class="drawer" aria-label="Settings">
    <div class="drawer-head">
      <strong>Settings</strong>
      <button id="btnClose" class="btn secondary" type="button">Close</button>
    </div>
    <div class="drawer-body">
      <div class="switch-row">
        <label for="toggleDark">Dark mode</label>
        <input id="toggleDark" type="checkbox" />
      </div>
      <div class="switch-row">
        <label for="toggleNepaliFont">Use Nepali font</label>
        <input id="toggleNepaliFont" type="checkbox" />
      </div>

      <div class="hr"></div>

      <div>
        <div class="lbl">Language</div>
        <div class="lang-choices">
          <label><input type="radio" name="lang" value="en" checked> English</label>
          <label><input type="radio" name="lang" value="np"> ‡§®‡•á‡§™‡§æ‡§≤‡•Ä</label>
        </div>
      </div>

      <div>
        <div class="lbl">Text size</div>
        <div class="lang-choices">
          <label><input type="radio" name="ts" value="sm"> Small</label>
          <label><input type="radio" name="ts" value="md" checked> Medium</label>
          <label><input type="radio" name="ts" value="lg"> Large</label>
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <div class="lbl">Voice tips</div>
        <label class="tiny"><input type="checkbox" id="voiceAuto"> Auto-play after selecting image</label>
        <p class="tiny muted">The app will speak instructions in the selected language.</p>
      </div>
    </div>
  </aside>
  <div id="scrim" class="scrim"></div>

  <!-- Hero / How it works -->
  <section class="hero">
    <div class="how-steps">
      <div class="how-step">
        <div class="how-icon">üì∏</div>
        <div class="how-text"><strong>1) Upload</strong><br><span class="muted tiny">‡§´‡•ã‡§ü‡•ã ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</span></div>
      </div>
      <div class="how-step">
        <div class="how-icon">ü§ñ</div>
        <div class="how-text"><strong>2) Analyze</strong><br><span class="muted tiny">‡§è‡§Ü‡§à‡§≤‡•á ‡§ú‡§æ‡§Å‡§ö ‡§ó‡§∞‡•ç‡§õ</span></div>
      </div>
      <div class="how-step">
        <div class="how-icon">üìÑ</div>
        <div class="how-text"><strong>3) Report</strong><br><span class="muted tiny">PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</span></div>
      </div>
    </div>
  </section>

  <!-- Main two-column: LEFT = Upload+Patient form, RIGHT = Patient + Results -->
  <main class="shell two-col">
    {% if error %}
      <div class="alert error" role="alert">‚ö†Ô∏è {{ error }}</div>
    {% endif %}

    <!-- LEFT -->
    <section>
      <form id="analyzeForm" class="step-card" method="post" enctype="multipart/form-data" action="{{ url_for('analyze') }}">
        <h2><span class="step-num">1</span> Upload Chest X-ray</h2>
        <p class="muted">JPG or PNG. We‚Äôll make a side-by-side heatmap and a one-page report PDF.</p>

        <div class="stack">
          <div>
            <div class="lbl">Image <span class="tiny muted">/ ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§°</span></div>
            <input id="fileInput" class="input" type="file" name="image" accept="image/*" required aria-label="Choose chest X-ray image">
            <div class="tiny muted">‡§ü‡§ø‡§™‡•ç‡§∏: ‡§õ‡§µ‡§ø ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü, ‡§õ‡§æ‡§§‡•Ä ‡§¨‡•Ä‡§ö‡§Æ‡§æ, ‡§ù‡§®‡•ç ‡§â‡§ú‡•ç‡§Ø‡§æ‡§≤‡•ã‡•§</div>
          </div>

          <div class="grid2">
            <div>
              <div class="lbl">Language / ‡§≠‡§æ‡§∑‡§æ</div>
              <select id="langSelect" class="input" name="lang" aria-label="Language">
                <option value="en" {% if not request.form.get('lang') or request.form.get('lang')=='en' %}selected{% endif %}>English</option>
                <option value="np" {% if request.form.get('lang')=='np' %}selected{% endif %}>‡§®‡•á‡§™‡§æ‡§≤‡•Ä</option>
              </select>
            </div>
            <div>
              <div class="lbl">Quick Tips / ‡§∏‡§ú‡§ø‡§≤‡•ã ‡§ü‡§ø‡§™‡•ç‡§∏</div>
              <div class="tiny muted">‚Ä¢ No blur ‚Ä¢ Good lighting ‚Ä¢ Chest centered</div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <h2><span class="step-num">2</span> Patient details</h2>
        <div class="grid3">
          <div>
            <div class="lbl">Full name / ‡§™‡•Å‡§∞‡§æ ‡§®‡§æ‡§Æ</div>
            <input class="input" type="text" name="patient_name" placeholder="e.g., Sita Rai" />
          </div>
          <div>
            <div class="lbl">Age / ‡§â‡§Æ‡•á‡§∞</div>
            <input class="input" type="number" min="0" max="120" name="patient_age" placeholder="e.g., 45" />
          </div>
          <div>
            <div class="lbl">Sex / ‡§≤‡§ø‡§ô‡•ç‡§ó</div>
            <select class="input" name="patient_sex">
              <option value="F" selected>F</option>
              <option value="M">M</option>
              <option value="‚Äî">‚Äî</option>
            </select>
          </div>
        </div>
        <div style="margin-top:10px">
          <div class="lbl">Patient ID (optional) / ‡§¨‡§ø‡§∞‡§æ‡§Æ‡•Ä ‡§Ü‡§à‡§°‡•Ä</div>
          <input class="input" type="text" name="patient_id" placeholder="Auto-generate if blank" />
        </div>

        <div class="actions">
          <button class="btn primary" type="submit">üîç Analyze</button>
          <button class="btn secondary" type="reset">Reset</button>
        </div>
      </form>
    </section>

    <!-- RIGHT -->
    <aside>
      <div class="step-card">
        <h2><span class="step-num">üë§</span> Patient</h2>
        {% set p = patient or {} %}
        <div class="profile-row" style="margin-top:6px">
          <div class="avatar" aria-hidden="true">{{ (p.get('name','P') or 'P')[0:1] }}</div>
          <div>
            <div class="pname">{{ p.get('name','‚Äî') }}</div>
            <div class="muted tiny">Basic details</div>
          </div>
        </div>

        <div class="stat-chips" aria-label="Patient details">
          <span class="stat">üÜî <strong>{{ p.get('id','‚Äî') }}</strong></span>
          <span class="stat">üéÇ Age: <strong>{{ p.get('age','‚Äî') }}</strong></span>
          <span class="stat">‚öß Sex: <strong>{{ p.get('sex','‚Äî') }}</strong></span>
        </div>
      </div>

      {% if decision %}
      <div class="step-card" aria-live="polite">
        <h2><span class="step-num">3</span> Results</h2>

        <div class="kpis">
          <span class="chip {% if risk_tier=='Low' %}healthy{% elif risk_tier=='Medium' %}attention{% else %}danger{% endif %}">
            {% if risk_tier=='Low' %}‚úÖ{% elif risk_tier=='Medium' %}‚ö†Ô∏è{% else %}‚ùå{% endif %}
            Risk: {{ risk_tier }}
          </span>
          <span class="chip">üß† Decision: <strong>{{ decision }}</strong></span>
          {% if suspected %}<span class="chip">üîé Top finding: {{ suspected }}</span>{% endif %}
        </div>

        <div class="risk-bar" aria-label="Risk meter" title="‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§∏‡•ç‡§§‡§∞">
          {% set tier = risk_tier or 'Low' %}
          {% set w = '30%' if tier=='Low' else ('65%' if tier=='Medium' else '95%') %}
          <span class="{% if tier=='Low' %}risk-low{% elif tier=='Medium' %}risk-mid{% else %}risk-high{% endif %}" style="width: {{ w }}"></span>
        </div>

        {% if headline %}<p><strong>Summary:</strong> {{ headline }}</p>{% endif %}

        {% if summary_en %}
          <details class="frame" style="margin-top:8px">
            <summary><strong>English explanation</strong></summary>
            <div class="tiny" style="margin-top:6px">
              {% if summary_en.impression %}<p><strong>Impression:</strong> {{ summary_en.impression }}</p>{% endif %}
              {% if summary_en.consider and summary_en.consider|length > 0 %}
                <p><strong>Key points:</strong></p>
                <ul>
                  {% for c in summary_en.consider[:3] %}<li>{{ c }}</li>{% endfor %}
                </ul>
              {% endif %}
            </div>
          </details>
        {% endif %}

        {% if summary_np %}
          <details class="frame" style="margin-top:8px">
            <summary><strong>‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ</strong></summary>
            <div class="tiny" style="margin-top:6px">
              {% if summary_np.impression %}<p><strong>‡§®‡§ø‡§∑‡•ç‡§ï‡§∞‡•ç‡§∑:</strong> {{ summary_np.impression|safe }}</p>{% endif %}
              {% if summary_np.consider and summary_np.consider|length > 0 %}
                <p><strong>‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ï‡•Å‡§∞‡§æ:</strong></p>
                <ul>
                  {% for c in summary_np.consider[:3] %}<li>{{ c|safe }}</li>{% endfor %}
                </ul>
              {% endif %}
            </div>
          </details>
        {% endif %}

        <div class="two-up bigger-images" style="margin-top:12px">
          <figure class="frame">
            {% if orig_url %}<img class="preview" src="{{ orig_url }}" alt="Uploaded chest X-ray">{% endif %}
            <figcaption class="cap">Original</figcaption>
          </figure>
          <figure class="frame">
            {% if cam_url %}<img class="preview" src="{{ cam_url }}" alt="Grad-CAM heatmap overlay">{% endif %}
            <figcaption class="cap">AI heatmap</figcaption>
          </figure>
        </div>

        <div class="actions" style="margin-top:12px">
          {% if pdf_url %}<a class="btn primary" href="{{ pdf_url }}" target="_blank" rel="noopener">üìÑ Download report (PDF)</a>{% endif %}
        </div>

        <details class="accordion" style="margin-top:8px">
          <summary>Advanced: See raw scores (JSON)</summary>
          <pre class="json">{{ card_json }}</pre>
        </details>
      </div>
      {% endif %}
    </aside>
  </main>

  <!-- Loading Overlay -->
  <div id="loading" class="loading hidden" role="alert" aria-live="assertive">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loadtext">Analyzing X-ray‚Ä¶ Please wait</div>
  </div>

  <!-- Feedback Dialog -->
  <dialog id="dlgFeedback" style="border:none;border-radius:16px;padding:0;max-width:480px;width:90%">
    <form method="dialog" style="padding:16px">
      <h3 style="margin:0 0 8px">Send Feedback</h3>
      <p class="tiny muted" style="margin-top:0">How can we make this easier for everyone in Nepal?</p>
      <textarea id="fbText" class="input" rows="5" placeholder="Your message‚Ä¶"></textarea>
      <div class="actions right">
        <button class="btn secondary" value="cancel">Cancel</button>
        <button id="fbSend" class="btn primary">Send</button>
      </div>
    </form>
  </dialog>

  <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
